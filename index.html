<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tezos Walkman Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

        body {
            font-family: 'Orbitron', 'Arial Black', sans-serif;
            background: 
                radial-gradient(ellipse at top, #ff6ec7 0%, transparent 60%),
                radial-gradient(ellipse at bottom, #4facfe 0%, transparent 60%),
                linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            position: relative;
            overflow: hidden;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    0deg,
                    rgba(255, 110, 199, 0.03) 0px,
                    transparent 1px,
                    transparent 2px,
                    rgba(79, 172, 254, 0.03) 3px
                );
            pointer-events: none;
        }

        body::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(120, 115, 245, 0.15) 0%, transparent 70%);
            transform: translate(-50%, -50%);
            pointer-events: none;
            animation: pulse-glow 4s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.1); }
        }

        .container {
            width: 100%;
            max-width: 450px;
            max-height: 90vh;
            perspective: 1500px;
            position: relative;
            z-index: 1;
        }

        .walkman {
            background: 
                linear-gradient(145deg, #ffeb3b 0%, #ffd600 50%, #ffca28 100%);
            border-radius: 28px;
            padding: 30px 28px;
            box-shadow: 
                0 30px 80px rgba(0, 0, 0, 0.5),
                0 15px 40px rgba(0, 0, 0, 0.3),
                inset 0 -8px 25px rgba(0, 0, 0, 0.15),
                inset 0 8px 25px rgba(255, 255, 255, 0.4),
                inset 2px 0 15px rgba(255, 255, 255, 0.3),
                inset -2px 0 15px rgba(0, 0, 0, 0.1);
            position: relative;
            border: 5px solid #1a1a1a;
            transform: translateZ(0);
            transition: transform 0.3s ease;
            aspect-ratio: 1 / 1.15;
        }

        .walkman:hover {
            transform: translateZ(10px);
        }

        /* Top clips/buttons */
        .top-clips {
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 80px;
            z-index: 10;
        }

        .clip {
            width: 50px;
            height: 35px;
            background: 
                linear-gradient(145deg, #2d2d3f 0%, #1a1a2a 100%);
            border-radius: 10px 10px 0 0;
            border: 4px solid #0a0a0a;
            border-bottom: none;
            position: relative;
            box-shadow: 
                0 -5px 15px rgba(0, 0, 0, 0.5),
                inset 0 3px 8px rgba(255, 255, 255, 0.1),
                inset 0 -3px 8px rgba(0, 0, 0, 0.5);
        }

        .clip::before {
            content: '';
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: 28px;
            height: 10px;
            background: linear-gradient(145deg, #3a3a4a, #2a2a3a);
            border-radius: 3px;
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.6),
                0 1px 2px rgba(255, 255, 255, 0.1);
        }

        /* Logo */
        .logo {
            text-align: left;
            font-size: 18px;
            font-weight: 900;
            letter-spacing: 2px;
            color: #0a0a0a;
            margin-bottom: 25px;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 
                1px 1px 0px rgba(255, 255, 255, 0.4),
                -1px -1px 0px rgba(0, 0, 0, 0.3);
        }

        /* Status LEDs */
        .status-leds {
            position: absolute;
            top: 60px;
            left: 35px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .led-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .led {
            width: 12px;
            height: 12px;
            background: 
                radial-gradient(circle at 30% 30%, #ff0080, #cc0066);
            border-radius: 50%;
            box-shadow: 
                0 0 15px rgba(255, 0, 128, 0.9),
                0 0 30px rgba(255, 0, 128, 0.6),
                inset 0 -3px 6px rgba(0, 0, 0, 0.4),
                inset 0 2px 4px rgba(255, 255, 255, 0.3);
            position: relative;
        }

        .led::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            filter: blur(1px);
        }

        .led.off {
            background: 
                radial-gradient(circle at 30% 30%, #4a0022, #2a0011);
            box-shadow: 
                inset 0 2px 6px rgba(0, 0, 0, 0.8),
                0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .led.off::after {
            display: none;
        }

        .led-label {
            font-size: 9px;
            font-weight: 700;
            color: #1a1a1a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        /* Control pod - the circular visualizer section */
        .control-pod {
            width: 200px;
            height: 200px;
            background: 
                radial-gradient(circle at 30% 30%, #1e1e2e, #0a0a15);
            border-radius: 50%;
            margin: 0 auto 20px;
            position: relative;
            box-shadow: 
                0 15px 40px rgba(0, 0, 0, 0.6),
                0 8px 20px rgba(0, 0, 0, 0.4),
                inset 0 -8px 20px rgba(0, 0, 0, 0.6),
                inset 0 8px 20px rgba(255, 255, 255, 0.05),
                inset 0 0 60px rgba(120, 115, 245, 0.1);
            border: 6px solid #0a0a0a;
            overflow: hidden;
        }

        .control-pod::before {
            content: '';
            position: absolute;
            top: 10%;
            left: 10%;
            width: 30%;
            height: 30%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1), transparent);
            border-radius: 50%;
            filter: blur(10px);
        }

        /* Visualizer canvas */
        .visualizer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Center FM label */
        .pod-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #ff6ec7;
            font-size: 14px;
            font-weight: 900;
            font-family: 'Orbitron', sans-serif;
            z-index: 2;
            text-shadow: 
                0 0 20px rgba(255, 110, 199, 0.8),
                0 0 40px rgba(255, 110, 199, 0.4);
            letter-spacing: 4px;
        }

        /* Control buttons below visualizer */
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
        }

        .control-btn {
            width: 55px;
            height: 55px;
            background: 
                linear-gradient(145deg, #2d2d3f, #1a1a2a);
            border-radius: 50%;
            border: 4px solid #0a0a0a;
            color: #00ffcc;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.4),
                inset 0 2px 6px rgba(255, 255, 255, 0.1),
                inset 0 -2px 6px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .control-btn::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2), transparent);
            border-radius: 50%;
            filter: blur(3px);
        }

        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 10px 30px rgba(0, 255, 204, 0.4),
                inset 0 2px 6px rgba(255, 255, 255, 0.2),
                inset 0 -2px 6px rgba(0, 0, 0, 0.5);
            color: #00ffcc;
            text-shadow: 0 0 10px rgba(0, 255, 204, 0.8);
        }

        .control-btn:active {
            transform: translateY(-1px);
        }

        /* Main play button - bigger and centered */
        .control-btn.play {
            width: 75px;
            height: 75px;
            background: 
                linear-gradient(145deg, #ff6ec7, #d84fa8);
            border: 5px solid #0a0a0a;
            color: #fff;
            font-size: 28px;
            box-shadow: 
                0 8px 30px rgba(255, 110, 199, 0.5),
                inset 0 3px 10px rgba(255, 255, 255, 0.2),
                inset 0 -3px 10px rgba(0, 0, 0, 0.4);
        }

        .control-btn.play::before {
            width: 30px;
            height: 30px;
            top: 5px;
            left: 5px;
        }

        .control-btn.play:hover {
            box-shadow: 
                0 12px 40px rgba(255, 110, 199, 0.7),
                0 0 60px rgba(255, 110, 199, 0.4),
                inset 0 3px 10px rgba(255, 255, 255, 0.3),
                inset 0 -3px 10px rgba(0, 0, 0, 0.4);
        }

        /* Side buttons */
        .side-btn {
            position: absolute;
            width: 45px;
            height: 24px;
            background: 
                linear-gradient(145deg, #f5f5f5, #d0d0d0);
            border-radius: 10px;
            border: 3px solid #0a0a0a;
            cursor: pointer;
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.4),
                inset 0 2px 4px rgba(255, 255, 255, 0.4),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }

        .side-btn:active {
            transform: translateY(2px);
            box-shadow: 
                0 2px 6px rgba(0, 0, 0, 0.4),
                inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .side-btn.off {
            top: 35px;
            right: -18px;
            background: linear-gradient(145deg, #ffffff, #e8e8e8);
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            color: #0a0a0a;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        .side-btn.mode {
            top: 75px;
            right: -18px;
        }

        /* Track display section */
        .track-display {
            background: 
                linear-gradient(145deg, #0f0f1f, #050508);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 18px;
            border: 4px solid #0a0a0a;
            box-shadow: 
                inset 0 4px 15px rgba(0, 0, 0, 0.9),
                inset 0 -2px 8px rgba(120, 115, 245, 0.1),
                0 4px 20px rgba(0, 0, 0, 0.3);
            min-height: 85px;
            position: relative;
            overflow: hidden;
        }

        .track-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(0, 255, 204, 0.3) 25%, 
                rgba(255, 110, 199, 0.3) 75%, 
                transparent 100%
            );
        }

        .track-title {
            font-size: 16px;
            font-weight: 900;
            color: #00ffcc;
            margin-bottom: 10px;
            text-shadow: 
                0 0 20px rgba(0, 255, 204, 1),
                0 0 40px rgba(0, 255, 204, 0.5),
                0 2px 4px rgba(0, 0, 0, 0.8);
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 1px;
        }

        .track-artist {
            font-size: 13px;
            color: #ff6ec7;
            text-shadow: 
                0 0 15px rgba(255, 110, 199, 0.8),
                0 0 30px rgba(255, 110, 199, 0.4),
                0 2px 4px rgba(0, 0, 0, 0.6);
            font-family: 'Orbitron', sans-serif;
            font-weight: 600;
        }

        .progress-container {
            margin-top: 15px;
            background: #000;
            border-radius: 5px;
            height: 8px;
            overflow: hidden;
            border: 2px solid #1a1a1a;
            box-shadow: 
                inset 0 2px 6px rgba(0, 0, 0, 0.8),
                0 1px 2px rgba(120, 115, 245, 0.2);
            position: relative;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ff6ec7, #7873f5, #00ffcc);
            transition: width 0.3s ease;
            box-shadow: 
                0 0 15px rgba(0, 255, 204, 0.8),
                0 0 30px rgba(255, 110, 199, 0.6);
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: #fff;
            box-shadow: 0 0 8px #fff;
        }

        /* Bottom branding */
        .bottom-brand {
            text-align: center;
            margin-top: 15px;
            margin-bottom: 15px;
        }

        .sports-text {
            font-size: 11px;
            font-weight: 900;
            color: #1a1a1a;
            letter-spacing: 3px;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 
                1px 1px 0px rgba(255, 255, 255, 0.3),
                -1px -1px 0px rgba(0, 0, 0, 0.2);
        }

        .walkman-fm {
            font-size: 30px;
            font-weight: 900;
            color: #0a0a0a;
            letter-spacing: 0px;
            line-height: 1;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 
                2px 2px 0px rgba(255, 255, 255, 0.4),
                -1px -1px 0px rgba(0, 0, 0, 0.2),
                3px 3px 8px rgba(0, 0, 0, 0.3);
        }

        /* Input section */
        .input-section {
            margin-bottom: 18px;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
        }

        input {
            flex: 1;
            background: rgba(15, 15, 31, 0.8);
            border: 3px solid #1a1a1a;
            border-radius: 10px;
            padding: 12px 15px;
            color: #00ffcc;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            font-weight: 600;
            outline: none;
            box-shadow: 
                inset 0 3px 10px rgba(0, 0, 0, 0.6),
                0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        input:focus {
            border-color: #00ffcc;
            box-shadow: 
                inset 0 3px 10px rgba(0, 0, 0, 0.6),
                0 0 20px rgba(0, 255, 204, 0.4),
                0 0 40px rgba(0, 255, 204, 0.2);
            text-shadow: 0 0 8px rgba(0, 255, 204, 0.6);
        }

        input::placeholder {
            color: rgba(0, 255, 204, 0.3);
            font-weight: 400;
        }

        .add-btn {
            background: 
                linear-gradient(145deg, #00ffcc, #00d4aa);
            border: 3px solid #0a0a0a;
            border-radius: 10px;
            padding: 12px 22px;
            color: #0a0a0a;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 
                0 6px 15px rgba(0, 255, 204, 0.4),
                inset 0 2px 6px rgba(255, 255, 255, 0.3),
                inset 0 -2px 6px rgba(0, 0, 0, 0.2);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .add-btn:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 10px 25px rgba(0, 255, 204, 0.6),
                0 0 40px rgba(0, 255, 204, 0.3),
                inset 0 2px 6px rgba(255, 255, 255, 0.4),
                inset 0 -2px 6px rgba(0, 0, 0, 0.2);
        }

        .add-btn:active {
            transform: translateY(-1px);
        }

        /* Playlist */
        .playlist {
            background: rgba(15, 15, 31, 0.6);
            border-radius: 15px;
            border: 3px solid #1a1a1a;
            padding: 12px;
            max-height: 150px;
            overflow-y: auto;
            box-shadow: 
                inset 0 3px 10px rgba(0, 0, 0, 0.7),
                0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .playlist::-webkit-scrollbar {
            width: 10px;
        }

        .playlist::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            margin: 5px;
        }

        .playlist::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #00ffcc, #7873f5);
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.5);
        }

        .playlist::-webkit-scrollbar-thumb:hover {
            box-shadow: 0 0 15px rgba(0, 255, 204, 0.8);
        }

        .playlist-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            background: rgba(26, 26, 46, 0.4);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .playlist-item:hover {
            background: rgba(0, 255, 204, 0.15);
            border-left-color: #00ffcc;
            box-shadow: 
                0 4px 12px rgba(0, 255, 204, 0.3),
                inset 0 0 20px rgba(0, 255, 204, 0.1);
        }

        .playlist-item.active {
            background: rgba(255, 110, 199, 0.15);
            border-left-color: #ff6ec7;
            box-shadow: 
                0 4px 12px rgba(255, 110, 199, 0.4),
                inset 0 0 20px rgba(255, 110, 199, 0.1);
        }

        .playlist-item-title {
            color: #00ffcc;
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 4px;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 10px rgba(0, 255, 204, 0.6);
            padding-right: 25px;
        }

        .playlist-item-artist {
            color: #ff6ec7;
            font-size: 11px;
            font-weight: 600;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 8px rgba(255, 110, 199, 0.5);
        }

        .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            background: rgba(255, 0, 80, 0.8);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
            line-height: 1;
            font-family: Arial, sans-serif;
        }

        .playlist-item:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            background: rgba(255, 0, 80, 1);
            transform: scale(1.1);
        }

        .loading {
            display: none;
            text-align: center;
            color: #00ffcc;
            font-size: 12px;
            padding: 10px;
            font-weight: 900;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 15px rgba(0, 255, 204, 0.8);
        }

        .loading.active {
            display: block;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading.active {
            animation: pulse 1.5s ease-in-out infinite;
        }

        .status {
            text-align: center;
            color: #1a1a1a;
            font-size: 11px;
            margin-top: 15px;
            font-weight: 700;
            opacity: 0.6;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="walkman">
            <!-- Top clips -->
            <div class="top-clips">
                <div class="clip"></div>
                <div class="clip"></div>
            </div>

            <!-- Logo -->
            <div class="logo">TEZOS</div>

            <!-- Status LEDs -->
            <div class="status-leds">
                <div class="led-row">
                    <div class="led" id="led1"></div>
                    <div class="led-label">ON/PLAY</div>
                </div>
                <div class="led-row">
                    <div class="led off" id="led2"></div>
                    <div class="led-label">FM STEREO</div>
                </div>
            </div>

            <!-- Side buttons -->
            <div class="side-btn off">OFF</div>
            <div class="side-btn mode"></div>

            <!-- Control pod with visualizer -->
            <div class="control-pod">
                <canvas class="visualizer" id="visualizer"></canvas>
                <div class="pod-display">FM</div>
            </div>

            <!-- Controls below visualizer -->
            <div class="controls">
                <button class="control-btn" onclick="previousTrack()" title="Previous">⏮</button>
                <button class="control-btn play" onclick="togglePlay()" id="playBtn" title="Play/Pause">▶</button>
                <button class="control-btn" onclick="nextTrack()" title="Next">⏭</button>
            </div>

            <!-- Track display -->
            <div class="track-display">
                <div class="track-title" id="trackTitle">Ready to play</div>
                <div class="track-artist" id="trackArtist">Add Objkt NFT link to begin</div>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
            </div>

            <!-- Bottom branding -->
            <div class="bottom-brand">
                <div class="sports-text">SPORTS</div>
                <div class="walkman-fm">TEZOS AUDIO</div>
            </div>

            <!-- Input section -->
            <div class="input-section">
                <div class="input-wrapper">
                    <input 
                        type="text" 
                        id="nftInput" 
                        placeholder="Paste Objkt.com NFT link..."
                    >
                    <button class="add-btn" onclick="addTrack()">ADD</button>
                </div>
            </div>

            <div class="loading" id="loading">LOADING TRACK DATA...</div>

            <!-- Playlist -->
            <div class="playlist" id="playlist"></div>

            <div class="status" id="status">Playlist empty</div>
        </div>
    </div>

    <audio id="audioPlayer" preload="auto"></audio>

    <script>
        let playlist = [];
        let currentTrackIndex = -1;
        let isPlaying = false;
        const audioPlayer = document.getElementById('audioPlayer');
        const playBtn = document.getElementById('playBtn');
        const progressBar = document.getElementById('progressBar');

        // LocalStorage key
        const STORAGE_KEY = 'tezos_walkman_playlist';

        // Load playlist from localStorage on page load
        function loadPlaylistFromStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    playlist = data.playlist || [];
                    currentTrackIndex = data.currentTrackIndex || -1;
                    
                    if (playlist.length > 0) {
                        updatePlaylist();
                        if (currentTrackIndex >= 0 && currentTrackIndex < playlist.length) {
                            loadTrack(currentTrackIndex);
                        }
                        updateStatus();
                    }
                }
            } catch (error) {
                console.error('Error loading playlist from storage:', error);
            }
        }

        // Save playlist to localStorage
        function savePlaylistToStorage() {
            try {
                const data = {
                    playlist: playlist,
                    currentTrackIndex: currentTrackIndex
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (error) {
                console.error('Error saving playlist to storage:', error);
            }
        }

        // Audio visualizer setup
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        let audioContext;
        let analyser;
        let dataArray;
        let bufferLength;
        let animationId;

        // Set canvas size
        function resizeCanvas() {
            const pod = document.querySelector('.control-pod');
            canvas.width = pod.offsetWidth;
            canvas.height = pod.offsetHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Initialize audio context and analyser
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 128;
                bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                const source = audioContext.createMediaElementSource(audioPlayer);
                source.connect(analyser);
                analyser.connect(audioContext.destination);
            }
        }

        // Retrowave visualizer animation
        function drawVisualizer() {
            animationId = requestAnimationFrame(drawVisualizer);
            
            if (!analyser) return;
            
            analyser.getByteFrequencyData(dataArray);
            
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            
            // Clear with dark gradient
            ctx.fillStyle = 'rgba(10, 10, 26, 0.25)';
            ctx.fillRect(0, 0, width, height);
            
            // Draw circular bars (retrowave style)
            const bars = 32;
            const radius = Math.min(width, height) * 0.35;
            
            for (let i = 0; i < bars; i++) {
                const angle = (Math.PI * 2 * i) / bars - Math.PI / 2;
                const dataIndex = Math.floor((i / bars) * bufferLength);
                const value = dataArray[dataIndex] || 0;
                const barHeight = (value / 255) * (radius * 0.5);
                
                // Calculate positions
                const x1 = centerX + Math.cos(angle) * radius;
                const y1 = centerY + Math.sin(angle) * radius;
                const x2 = centerX + Math.cos(angle) * (radius + barHeight);
                const y2 = centerY + Math.sin(angle) * (radius + barHeight);
                
                // Create gradient for each bar
                const gradient = ctx.createLinearGradient(x1, y1, x2, y2);
                
                // Vaporwave color scheme based on position
                if (i < bars / 3) {
                    gradient.addColorStop(0, 'rgba(255, 110, 199, 0.1)');
                    gradient.addColorStop(1, 'rgba(255, 110, 199, 0.9)');
                } else if (i < (bars * 2) / 3) {
                    gradient.addColorStop(0, 'rgba(120, 115, 245, 0.1)');
                    gradient.addColorStop(1, 'rgba(120, 115, 245, 0.9)');
                } else {
                    gradient.addColorStop(0, 'rgba(0, 255, 204, 0.1)');
                    gradient.addColorStop(1, 'rgba(0, 255, 204, 0.9)');
                }
                
                // Draw bar
                ctx.beginPath();
                ctx.strokeStyle = gradient;
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
                
                // Add glow effect
                ctx.shadowBlur = 15;
                ctx.shadowColor = gradient;
                ctx.stroke();
                ctx.shadowBlur = 0;
            }
            
            // Draw center circle
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius * 0.3, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(10, 10, 26, 0.8)';
            ctx.fill();
            ctx.strokeStyle = 'rgba(255, 110, 199, 0.3)';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // Start visualizer
        function startVisualizer() {
            if (!animationId) {
                drawVisualizer();
            }
        }

        // Stop visualizer
        function stopVisualizer() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
        }

        // Extract token ID and contract from Objkt URL
        function extractTokenId(url) {
            // Remove trailing slashes and query params
            url = url.split('?')[0].replace(/\/$/, '');
            
            const patterns = [
                // New Objkt format: objkt.com/asset/CONTRACT/TOKEN
                {
                    regex: /objkt\.com\/asset\/([^\/]+)\/(\d+)/,
                    handler: (match) => ({ contract: match[1], tokenId: match[2] })
                },
                // Hic et nunc format: objkt.com/tokens/hicetnunc/TOKEN
                {
                    regex: /objkt\.com\/tokens\/hicetnunc\/(\d+)/,
                    handler: (match) => ({ 
                        contract: 'KT1RJ6PbjHpwc3M5rw5s2Nbmefwbuwbdxton', // hic et nunc v2 contract
                        tokenId: match[1] 
                    })
                },
                // Generic tokens format: objkt.com/tokens/CONTRACT/TOKEN
                {
                    regex: /objkt\.com\/tokens\/([^\/]+)\/(\d+)/,
                    handler: (match) => ({ contract: match[1], tokenId: match[2] })
                },
                // Just a number at the end
                {
                    regex: /\/(\d+)$/,
                    handler: (match) => ({ 
                        contract: 'KT1RJ6PbjHpwc3M5rw5s2Nbmefwbuwbdxton', // assume hic et nunc
                        tokenId: match[1] 
                    })
                }
            ];
            
            for (let pattern of patterns) {
                const match = url.match(pattern.regex);
                if (match) {
                    return pattern.handler(match);
                }
            }
            return null;
        }

        // Fetch NFT metadata from Objkt API
        async function fetchNFTData(url) {
            const tokenInfo = extractTokenId(url);
            if (!tokenInfo) {
                throw new Error('Invalid Objkt URL - please use format: objkt.com/tokens/hicetnunc/TOKEN_ID or objkt.com/asset/CONTRACT/TOKEN_ID');
            }

            console.log('Fetching token:', tokenInfo);

            // Query for the token
            const query = `
                query getToken {
                    token(where: {
                        fa_contract: {_eq: "${tokenInfo.contract}"},
                        token_id: {_eq: "${tokenInfo.tokenId}"}
                    }) {
                        token_id
                        name
                        artifact_uri
                        mime_type
                        fa_contract
                        creators {
                            holder {
                                alias
                                address
                            }
                        }
                    }
                }
            `;

            try {
                const response = await fetch('https://data.objkt.com/v3/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query })
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const data = await response.json();
                
                console.log('API response:', data);
                
                if (data.errors) {
                    console.error('GraphQL errors:', data.errors);
                    throw new Error('GraphQL query failed: ' + JSON.stringify(data.errors));
                }
                
                if (!data.data || !data.data.token || data.data.token.length === 0) {
                    throw new Error(`NFT not found. Contract: ${tokenInfo.contract}, Token ID: ${tokenInfo.tokenId}`);
                }

                const token = data.data.token[0];
                
                console.log('Token data:', token);
                
                if (!token.mime_type || !token.mime_type.includes('audio')) {
                    throw new Error(`This NFT is not an audio file (mime type: ${token.mime_type || 'unknown'}). Only audio NFTs are supported.`);
                }

                // Handle IPFS URLs
                let audioUrl = token.artifact_uri;
                if (audioUrl.startsWith('ipfs://')) {
                    audioUrl = audioUrl.replace('ipfs://', 'https://ipfs.io/ipfs/');
                } else if (audioUrl.startsWith('Qm')) {
                    audioUrl = 'https://ipfs.io/ipfs/' + audioUrl;
                }

                const artistName = token.creators && token.creators[0] 
                    ? (token.creators[0].holder.alias || token.creators[0].holder.address.slice(0, 8) + '...')
                    : 'Unknown Artist';

                return {
                    title: token.name || 'Untitled',
                    artist: artistName,
                    url: audioUrl,
                    tokenId: token.token_id,
                    contract: token.fa_contract
                };
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }

        async function addTrack() {
            const input = document.getElementById('nftInput');
            const url = input.value.trim();
            
            if (!url) {
                alert('Please enter a valid Objkt URL');
                return;
            }

            const loading = document.getElementById('loading');
            loading.classList.add('active');

            try {
                const trackData = await fetchNFTData(url);
                playlist.push(trackData);
                updatePlaylist();
                input.value = '';
                
                if (currentTrackIndex === -1) {
                    currentTrackIndex = 0;
                    loadTrack(0);
                }
                
                updateStatus();
                savePlaylistToStorage(); // Save to localStorage
            } catch (error) {
                alert('Error loading track: ' + error.message);
                console.error(error);
            } finally {
                loading.classList.remove('active');
            }
        }

        function updatePlaylist() {
            const playlistEl = document.getElementById('playlist');
            playlistEl.innerHTML = '';
            
            playlist.forEach((track, index) => {
                const item = document.createElement('div');
                item.className = 'playlist-item' + (index === currentTrackIndex ? ' active' : '');
                item.onclick = () => {
                    currentTrackIndex = index;
                    loadTrack(index);
                    play();
                    savePlaylistToStorage(); // Save current track
                };
                
                // Add delete button
                const deleteBtn = document.createElement('span');
                deleteBtn.innerHTML = '✕';
                deleteBtn.className = 'delete-btn';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeTrack(index);
                };
                
                item.innerHTML = `
                    <div class="playlist-item-title">${track.title}</div>
                    <div class="playlist-item-artist">${track.artist}</div>
                `;
                
                item.appendChild(deleteBtn);
                playlistEl.appendChild(item);
            });
        }

        function removeTrack(index) {
            if (confirm('Remove this track from playlist?')) {
                playlist.splice(index, 1);
                
                // Update current track index
                if (currentTrackIndex === index) {
                    if (playlist.length > 0) {
                        currentTrackIndex = Math.min(currentTrackIndex, playlist.length - 1);
                        loadTrack(currentTrackIndex);
                    } else {
                        currentTrackIndex = -1;
                        document.getElementById('trackTitle').textContent = 'Ready to play';
                        document.getElementById('trackArtist').textContent = 'Add Objkt NFT link to begin';
                        pause();
                    }
                } else if (index < currentTrackIndex) {
                    currentTrackIndex--;
                }
                
                updatePlaylist();
                updateStatus();
                savePlaylistToStorage();
            }
        }

        function loadTrack(index) {
            if (index < 0 || index >= playlist.length) return;
            
            const track = playlist[index];
            audioPlayer.src = track.url;
            
            document.getElementById('trackTitle').textContent = track.title;
            document.getElementById('trackArtist').textContent = track.artist;
            
            updatePlaylist();
            savePlaylistToStorage(); // Save current track position
        }

        function togglePlay() {
            if (playlist.length === 0) {
                alert('Add tracks to your playlist first!');
                return;
            }

            if (isPlaying) {
                pause();
            } else {
                play();
            }
        }

        function play() {
            initAudioContext();
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            audioPlayer.play();
            isPlaying = true;
            playBtn.innerHTML = '⏸';
            document.getElementById('led1').classList.remove('off');
            startVisualizer();
        }

        function pause() {
            audioPlayer.pause();
            isPlaying = false;
            playBtn.innerHTML = '▶';
            document.getElementById('led1').classList.add('off');
        }

        function nextTrack() {
            if (playlist.length === 0) return;
            
            currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
            loadTrack(currentTrackIndex);
            
            if (isPlaying) {
                play();
            }
        }

        function previousTrack() {
            if (playlist.length === 0) return;
            
            currentTrackIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
            loadTrack(currentTrackIndex);
            
            if (isPlaying) {
                play();
            }
        }

        function updateStatus() {
            const status = document.getElementById('status');
            if (playlist.length === 0) {
                status.textContent = 'Playlist empty';
            } else {
                status.textContent = `${playlist.length} track${playlist.length > 1 ? 's' : ''} loaded`;
            }
        }

        // Audio event listeners
        audioPlayer.addEventListener('timeupdate', () => {
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressBar.style.width = progress + '%';
        });

        audioPlayer.addEventListener('ended', () => {
            nextTrack();
        });

        audioPlayer.addEventListener('error', (e) => {
            console.error('Audio playback error:', e);
            alert('Error playing audio. The file might be unavailable or in an unsupported format.');
        });

        // Allow Enter key to add tracks
        document.getElementById('nftInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTrack();
            }
        });

        // Load saved playlist on page load
        loadPlaylistFromStorage();

        // Start visualizer even when paused for aesthetic
        drawVisualizer();
    </script>
</body>
</html>
